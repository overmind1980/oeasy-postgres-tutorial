---
show: step
version: 1.0
enable_checker: true
---

#  åµŒå¥—æŸ¥è¯¢_æ ¹æ®èšåˆå‡½æ•°ç»“æœ_è¿›è¡ŒæŸ¥è¯¢
 

##  å›å¿†

- ä¸Šæ¬¡å­˜å‚¨è¿‡ç¨‹
	- stored procedure
	- æŠŠéœ€è¦å¤„ç†çš„æµç¨‹å­˜å‚¨å¥½ ç„¶åè°ƒç”¨æ‰§è¡Œ
	- å­˜å‚¨è¿‡ç¨‹èƒ½å¤Ÿéå†ç»“æœé›†å—ï¼Ÿï¼ŸğŸ¤”

### éå†ç»“æœé›†


```
\c sanguo
CREATE OR REPLACE PROCEDURE test_proc()
    LANGUAGE plpgsql
    AS $$
    DECLARE
		var_items RECORD;
        cur_items CURSOR FOR
            SELECT name
            FROM items;
    BEGIN
        OPEN cur_items;
        LOOP
            FETCH cur_items INTO var_items;
            EXIT WHEN NOT FOUND;
            RAISE NOTICE 'items: %', var_items.name;
        END LOOP;
        CLOSE cur_items;
    END;
    $$;

CALL test_proc();
```

- éå† æ‰€æœ‰å®ç‰©

![å›¾ç‰‡æè¿°](https://doc.shiyanlou.com/courses/uid1190679-20231003-1696303344950)

### ä½¿ç”¨æ¸¸æ ‡éå†ç»“æœé›†

```
\c sanguo
CREATE OR REPLACE PROCEDURE test_proc()
    LANGUAGE plpgsql
    AS $$
    DECLARE
		var_items RECORD;
        cur_items CURSOR FOR
            SELECT name
            FROM items
            WHERE city = 'é•¿å®‰';
    BEGIN
        OPEN cur_items;
        LOOP
            FETCH cur_items INTO var_items;
            EXIT WHEN NOT FOUND;
            RAISE NOTICE 'items: %', var_items.name;
        END LOOP;
        CLOSE cur_items;
    END;
    $$;

CALL test_proc();
```

- éå†é•¿å®‰çš„å®ç‰©

![å›¾ç‰‡æè¿°](https://doc.shiyanlou.com/courses/uid1190679-20231003-1696303265474)

### å˜é‡èµ‹å€¼

- ä½¿ç”¨SELECT INTOè¿›è¡Œèµ‹å€¼

```
\c sanguo
CREATE OR REPLACE PROCEDURE test_proc()
    LANGUAGE plpgsql
    AS $$
    DECLARE
		var_city TEXT;
		var_items RECORD;
        cur_items CURSOR FOR
            SELECT name
            FROM items
			WHERE city = var_city;
    BEGIN
        SELECT city
			INTO var_city 
			FROM items
			WHERE name = 'å­™å­å…µæ³•'
			LIMIT 1;
		RAISE NOTICE 'city: %', var_city;
        OPEN cur_items;
        LOOP
            FETCH cur_items INTO var_items;
            EXIT WHEN NOT FOUND;
            RAISE NOTICE 'items: %', var_items.name;
        END LOOP;
        CLOSE cur_items;
    END;
    $$;

CALL test_proc();
```

- æŸ¥æ‰¾åˆ°å­™å­å…µæ³•æ‰€åœ¨åŸå¸‚çš„æ‰€æœ‰å®ç‰©

![å›¾ç‰‡æè¿°](https://doc.shiyanlou.com/courses/uid1190679-20231003-1696303817280)

- è¿™å°±æœ‰ç‚¹åµŒå¥—æŸ¥è¯¢çš„æ„æ€äº†

### åµŒå¥—æ–¹å¼

- åŸå§‹ä»£ç 

```
\c sanguo

SELECT 
	name
FROM
	heroes
WHERE
	nation =(
		SELECT
			nation
		FROM
			heroes
		WHERE
			name = 'æ›¹æ“'
	)
;
```

- æƒ³åŠæ³•å¾—åˆ°æ›¹æ“å¯¹åº”çš„å›½å®¶
	- å†æ ¹æ®å›½å®¶å¾—åˆ°æ‰€æœ‰è¯¥å›½æ­¦å°†

### å­˜å‚¨è¿‡ç¨‹

```
\c sanguo
CREATE OR REPLACE PROCEDURE test_proc()
    LANGUAGE plpgsql
    AS $$
    DECLARE
        var_nation TEXT;
        var_heroes RECORD;
        cur_heroes CURSOR FOR
            SELECT name
            FROM heroes
            WHERE nation = var_nation;
    BEGIN
        SELECT nation
        INTO var_nation 
        FROM heroes
        WHERE name = 'æ›¹æ“'
        LIMIT 1;
        
        RAISE NOTICE 'nation: %', var_nation ;
        
        OPEN cur_heroes;
        LOOP
            FETCH cur_heroes INTO var_heroes;
            EXIT WHEN NOT FOUND;
            RAISE NOTICE 'hero: %', var_heroes.name;
        END LOOP;
        CLOSE cur_heroes;
    END;
    $$;

CALL test_proc();
```

- é€šè¿‡éå†æ¸¸æ ‡CURSOR
	- å¾—åˆ°æ‰€æœ‰çš„æ­¦å°†å§“å

![å›¾ç‰‡æè¿°](https://doc.shiyanlou.com/courses/uid1190679-20231003-1696297722818)

- æ¸¸æ ‡ä½¿ç”¨æœ‰ä»€ä¹ˆç‰¹ç‚¹å‘¢ï¼Ÿ

### æ¸¸æ ‡ä½¿ç”¨è¿‡ç¨‹

1. å®šä¹‰æ¸¸æ ‡
2. æ‰“å¼€æ¸¸æ ‡
3. éå†æ¸¸æ ‡
4. å…³é—­æ¸¸æ ‡

![å›¾ç‰‡æè¿°](https://doc.shiyanlou.com/courses/uid1190679-20231003-1696299722650)

- é€šè¿‡è¿™æ ·çš„æ–¹å¼å¯ä»¥éå†æ¸¸æ ‡

## æ€»ç»“ğŸ¤”

- è¿™æ¬¡äº†è§£äº†æ¸¸æ ‡ä½¿ç”¨è¿‡ç¨‹
	1. å®šä¹‰æ¸¸æ ‡
	2. æ‰“å¼€æ¸¸æ ‡
	3. éå†æ¸¸æ ‡
	4. å…³é—­æ¸¸æ ‡
- å¯ä»¥å°†æ•°å€¼ä½œä¸ºå‚æ•°ä¼ å…¥å­˜å‚¨è¿‡ç¨‹å—ï¼ŸğŸ¤”
- ä¸‹æ¬¡å†è¯´ï¼ŸğŸ‘‹ğŸ»
