---
show: step
version: 1.0
enable_checker: true
---

#    ä¸»é”®_å¤–é”®_ä¸»è¡¨_ä»è¡¨_foreign_key_master_table       
 
##  å›å¿†

- ä¸Šæ¬¡åˆ›å»ºäº†ä¸€ä¸ªåˆ é™¤è®°å½•çš„è§¦å‘å™¨
	- åˆ é™¤ æ¡£å£ è®°å½•
	- å‡½æ•° ä½œç”¨æ˜¯ åˆ é™¤æ¡£å£ç›¸å…³çš„è´¦å•è®°å½•
- å¦‚æœæˆ‘æƒ³åœ¨æ’å…¥ä¹‹å‰åˆ¤æ–­
	- å¦‚æœåº—é“ºå­˜åœ¨ 
		- åªæ’å…¥è´¦å•
	- å¦‚æœåº—é“ºä¸å­˜åœ¨
		- æ’å…¥è´¦å•å’Œåº—é“º 
- è¿™ä¸ªéœ€æ±‚å¯ä»¥åšå—ï¼Ÿ

### åˆ†æéœ€æ±‚

- æƒ³è¦æ’å…¥æ—§åº—é“ºè´¦å•
	- ic1003532,dk1001584,2023-10-01,10:00:00,10,è€å®¶è‚‰é¥¼,åˆ˜è€æ ¹
	- ç”±äºåˆ˜è€æ ¹çš„è€å®¶è‚‰é¥¼åº—é“ºçš„dk_idå·²å­˜åœ¨ï¼Œåªæ’å…¥è´¦å•è¡¨(bill)
- å¦‚æœæœ‰ä¸€ä¸ªæ–°çš„æ¡£å£
	- ic1003533,dk1001589,2023-10-01,11:00:00,10,æ²™å¿å°åƒ,æ²™è€æ¿
    - ç”±äºæ–°æ¡£å£ ä¸å­˜åœ¨ éœ€è¦åœ¨ä¸¤ä¸ªè¡¨æ’å…¥è®°å½•

- è¿™é‡Œé¢æœ‰ä¸€ä¸ª
	- å…ˆæŸ¥è¯¢ å†åˆ†ç±»å¤„ç†çš„å‡½æ•°

### æ„å»ºå‡½æ•°

```
\c chinese_food_city
DROP FUNCTION insert_bill_and_stall;
 
CREATE OR REPLACE FUNCTION insert_bill_and_stall(
    new_ic_id text,
    new_dk_id text,
    new_deal_time timestamp,
    new_price numeric,
    new_shop text,
    new_shop_owner text
)
RETURNS void AS $$
BEGIN
    -- æ£€æŸ¥æ¡£å£æ˜¯å¦å·²å­˜åœ¨
    IF EXISTS (SELECT 1 FROM public.stall WHERE dk_id = new_dk_id) THEN
        -- å¦‚æœå­˜åœ¨ï¼Œåªæ’å…¥è´¦å•è¡¨
        INSERT INTO public.bill (ic_id, dk_id, deal_time, price) 
            VALUES (new_ic_id, new_dk_id, new_deal_time, new_price);
 
    ELSE
        -- å¦‚æœä¸å­˜åœ¨ï¼Œæ’å…¥æ¡£å£è¡¨å’Œè´¦å•è¡¨
        INSERT INTO public.stall (dk_id, shop, shop_owner) 
            VALUES (new_dk_id, new_shop, new_shop_owner);
        INSERT INTO public.bill (ic_id, dk_id, deal_time, price) 
            VALUES (new_ic_id, new_dk_id, new_deal_time, new_price);
    END IF;
END;
$$ LANGUAGE plpgsql;


```

- åˆ›å»ºç»“æœ

![å›¾ç‰‡æè¿°](https://doc.shiyanlou.com/courses/uid1190679-20231006-1696564491621)

### å°è¯•æ’å…¥

```
\c chinese_food_city

SELECT public.insert_bill_and_stall(
    'ic1003532', 
    'dk1001584', 
    TIMESTAMP '2023-10-01 10:00:00', 
    10, 
    'è€å®¶è‚‰é¥¼', 
    'åˆ˜è€æ ¹'
);
```

- æ‰§è¡Œç»“æœ

![å›¾ç‰‡æè¿°](https://doc.shiyanlou.com/courses/uid1190679-20231006-1696568281033)

### æŸ¥è¯¢æ•°æ®

```
SELECT 
	*
FROM
	bill;
```

- æŸ¥è¯¢ç»“æœ

![å›¾ç‰‡æè¿°](https://doc.shiyanlou.com/courses/uid1190679-20231006-1696568335484)

### æŸ¥è¯¢stall

```
SELECT 
	*
FROM
	stall;
```

- ç»“æœ

![å›¾ç‰‡æè¿°](https://doc.shiyanlou.com/courses/uid1190679-20231006-1696568386946)

- å¹¶æ²¡æœ‰æ’å…¥æ–°çš„åº—é“º

### å°è¯•æ’å…¥æ–°çš„æ•°æ®

```
\c chinese_food_city

SELECT insert_bill_and_stall(
    'ic1003592', 
    'dk1001589', 
    TIMESTAMP '2023-10-01 10:00:00', 
    10, 
    'äº¬å‘³æ¥¼', 
    'åˆ˜è€æ ¹'
);
```

- æ‰§è¡Œæ²¡æœ‰æŠ¥é”™

### æŸ¥è¯¢

```
\c chinese_food_city
SELECT 
	*
FROM
	bill;

SELECT 
	*
FROM
	stall;
```

- æŸ¥è¯¢ç»“æœ

![å›¾ç‰‡æè¿°](https://doc.shiyanlou.com/courses/uid1190679-20231006-1696568582584/wm)
##  æ€»ç»“

- è¿™æ¬¡æˆ‘ä»¬å®šä¹‰äº†ç‰¹æ®Šçš„æ’å…¥å‡½æ•°
	- å¦‚æœæ¡£å£idå·²ç»å­˜åœ¨
		- åˆ™ä¸æ’å…¥æ¡£å£æ•°æ®
	- å¦åˆ™
		- åŒæ—¶æ’å…¥æ¡£å£å’Œè´¦å•æ•°æ®
- åœ¨æœ¬ç« é‡Œé¢æˆ‘ä»¬
	- æ·±å…¥äº†è§£äº†2NF
		- 2NFä¸­å–æ¶ˆäº†éä¸»å±æ€§å¯¹äºä¸»å±æ€§çš„éƒ¨åˆ†ä¾èµ–
	- äº†è§£äº†è§†å›¾
	- æ·±å…¥äº†å‡½æ•°
	- åº”ç”¨äº†è§¦å‘å™¨
- æœ‰æ²¡æœ‰3NFå‘¢ï¼ŸğŸ¤”
- ä¸‹æ¬¡å†è¯´ï¼ŸğŸ‘‹

