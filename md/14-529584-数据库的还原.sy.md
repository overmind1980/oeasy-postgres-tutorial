---
show: step
version: 1.0
enable_checker: true
---

# 总结

## 回忆

- 上次尝试备份数据库
- 用的命令是pg_dump

![图片描述](https://doc.shiyanlou.com/courses/uid1190679-20220721-1658408469748)

- dump的意思是转储
- 把数据库转储到一个sql文件中
- 然后就可以进行还原了
- 具体怎么还原呢?🤔



### 查询帮助

![图片描述](https://doc.shiyanlou.com/courses/uid1190679-20220721-1658405932882)

- 好像就是一句话
- 我们先去把原来的库给删掉

### 删除原库

![图片描述](https://doc.shiyanlou.com/courses/uid1190679-20220721-1658407497244)

- 删掉是为了看看他是否能恢复

### 恢复oeasydb中的数据表

![图片描述](https://doc.shiyanlou.com/courses/uid1190679-20220721-1658406118719)

- 我们尝试打开或者执行oeasydb.sql
- 但是系统说找不到
- 这是为什么呢？

### 当前用户

- 我们是用postgres用户执行的psql
- 所以当前的用户文件夹是postgres的用户文件夹
- 也就是/var/lib/postgresql/
- 我们需要写出oeasydb.sql的绝对路径 

![图片描述](https://doc.shiyanlou.com/courses/uid1190679-20220721-1658407556263)

- 可以找到sql了 
- 但是库没有了
- 就不能恢复了么？
- 看看帮助

### 帮助

![图片描述](https://doc.shiyanlou.com/courses/uid1190679-20220721-1658407696261)

- 库名不能被恢复
- 难道这个备份文件里面没有CREATE DATABASE?

### 查看dump转储文件

![图片描述](https://doc.shiyanlou.com/courses/uid1190679-20220721-1658407827250)

- 确实如此
- 第一个CREATE的就是TABLE
- 我们需要手动建好oeasydb这个库

### 建库

![图片描述](https://doc.shiyanlou.com/courses/uid1190679-20220721-1658408451318)

- 建好库了
- 尝试还原

### 还原

![图片描述](https://doc.shiyanlou.com/courses/uid1190679-20220721-1658408607436)

- 这里用到的应该是输入重定向

### 还原过程
![图片描述](https://doc.shiyanlou.com/courses/uid1190679-20220721-1658409236126)

- 还原成功了么？

### 检验

![图片描述](https://doc.shiyanlou.com/courses/uid1190679-20220721-1658409269065)

- 确实成功了
- 如果再恢复一次会发生什么呢？
- 再观察一下oeasydb.sql

### 分析

![图片描述](https://doc.shiyanlou.com/courses/uid1190679-20220721-1658405496217)

- 建表的语句会发生ERROR
- 插数据应该可以插入
- 去试试

### 再恢复

![图片描述](https://doc.shiyanlou.com/courses/uid1190679-20220721-1658411860162)

- 确实如我们所料
- 出现了ERROR
- 那后面的数据插进去了么？

### 重复数据

![图片描述](https://doc.shiyanlou.com/courses/uid1190679-20220721-1658411930332)

- 遇到ERROR之后没有停止
- 继续执行后面的插数据操作
- 结果就是
- 数据重复了
- 能否让他遇到ERROR就停下来呢？

### 查看帮助
![图片描述](https://doc.shiyanlou.com/courses/uid1190679-20220721-1658412132234)

### 运行

![图片描述](https://doc.shiyanlou.com/courses/uid1190679-20220721-1658412260107)

- 这次遇到ERROR就会自动停止下来了
- 后面插数据的部分就不会执行了

### 继续观察帮助

![图片描述](https://doc.shiyanlou.com/courses/uid1190679-20220721-1658412583927)

- 可以加上参数 
- 让本次恢复过程作为一个事务(Transaction)
	- 要么全做
	- 要么不做

### 尝试

![图片描述](https://doc.shiyanlou.com/courses/uid1190679-20220721-1658412766735)

- 最终数据如何？

### 最终数据

![图片描述](https://doc.shiyanlou.com/courses/uid1190679-20220721-1658412809120)

- 由于遇到了ERROR
- 这个事务决定都不做
- 于是进行了回滚(ROLL BACK)
- 帮助里面还有什么交代的呢？

### 远程备份加还原

![图片描述](https://doc.shiyanlou.com/courses/uid1190679-20220721-1658412925623)

- 这个管道的前面
- 应该生成的是sql语句
- 后面能执行么？
- 查询一下psql的参数

![图片描述](https://doc.shiyanlou.com/courses/uid1190679-20220721-1658413386323)

- psql是可以直接执行sql语句的
- 也就是说把host1上面dbname生成的一些sql语句
- 通过管道放到host2的dbname去执行
- 能否备份还原多个数据库呢？

### 多个数据库

![图片描述](https://doc.shiyanlou.com/courses/uid1190679-20220721-1658413521740)

- 应该是可以备份还原多个数据库的
- 基本先这样
- 我们总结去

## 总结

- 这一次我们还原了数据库
- 本质上就是通过psql执行了相应的sql语句
- sql语句是将当前数据库传储得到的
- 然后我们就可以备份还原数据库了 

![图片描述](https://doc.shiyanlou.com/courses/uid1190679-20220722-1658461343039)

- 不过备份的语句里面好像没有用到INSERT语句
- 那究竟是怎么插入数据的呢？🤔
- 我们下次再说！👋🏻
