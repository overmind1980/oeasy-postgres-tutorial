---
show: step
version: 1.0
enable_checker: true
---

# 总结

## 回忆

- 上次希望不在shell和psql中来回反复横跳
- 全都在psql中执行好一切命令
	- \e 进行编辑
	- \i 进行运行
- 这样就可以不用\q退回到shell了
- 还有更好用的工作流么？
- 我们下次再说

![图片描述](https://doc.shiyanlou.com/courses/uid1190679-20220721-1658391401106)

### 查询外部命令

- 我们尝试观察一下psql命令的参数

![图片描述](https://doc.shiyanlou.com/courses/uid1190679-20220721-1658391837636)

### 尝试运行

- 在shell中用vim打开/tmp/test.sql

![图片描述](https://doc.shiyanlou.com/courses/uid1190679-20220721-1658391925146)

- 并尝试运行

![图片描述](https://doc.shiyanlou.com/courses/uid1190679-20220721-1658391973290)

- 发现shiyanlou这个用户
- 不能运行psql这个命令
- 怎么办呢？

### 修改

- 修改命令行参数

![图片描述](https://doc.shiyanlou.com/courses/uid1190679-20220721-1658392073411)

- 运行成功

![图片描述](https://doc.shiyanlou.com/courses/uid1190679-20220721-1658392092634)

- 这样我们确实不离开vim
- 就可以编辑并运行sql语句了
- 但是有没有更好的方式呢？

### 工作流调优

![图片描述](https://doc.shiyanlou.com/courses/uid1190679-20220721-1658392161496)

- 我们首先进入psql
- 并对/tmp/test.sql进行编辑

### 保存并编辑sql文件

![图片描述](https://doc.shiyanlou.com/courses/uid1190679-20220721-1658392252435)

- 确实是可以执行sql语句的

![图片描述](https://doc.shiyanlou.com/courses/uid1190679-20220721-1658392325616)

- 为什么不用加sudo -u postgres呢？

### 用户

![图片描述](https://doc.shiyanlou.com/courses/uid1190679-20220721-1658392460418)

- 我们运行psql命令的时候
- 是以postgres这个用户来运行的
- 所以在psql中我们进入vim的时候
- 还是以postgres用户来运行的
- 在vim中运行外部命令的时候
- 用户还是postgres
- postgres刚好是能执行psql命令的用户
- 所以就可以直接执行了

![图片描述](https://doc.shiyanlou.com/courses/uid1190679-20220721-1658392626546)

- 除此之外还有个前提

### 另一个前提

- 还有个前提是postgres用户有/tmp/test.sql的写权限

![图片描述](https://doc.shiyanlou.com/courses/uid1190679-20220721-1658390504342)

- 现在我们可以不出psql
- 就在vim中编辑并运行sql文件
- 也可以在psql中进行调试
- 我觉得这就是最好的工作流了
- 如果您还有更好的
- 请通过纠错告诉我
- 我们一起让教程进步

### 总结

- 这次我们优化了工作流
1. 先进psql
2. \e /tmp/test.sql 编辑sql文件
3. :w|!psql -f % 保存并运行sql文件
4. :q 退回到psql执行其他的交互命令

- 这样确实可以进行初始化了 

![图片描述](https://doc.shiyanlou.com/courses/uid1190679-20220721-1658393108067)

- 但是如果我们不想恢复到出厂状态
- 而是希望把当前状态备份
- 方便以后可以进行还原
- 应该怎么做呢？🤔
- 我们下次再说👋🏻